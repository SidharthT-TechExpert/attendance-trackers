<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Report Manager ‚Äî Attendance</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles/report-manager.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body>
  <!-- Loader -->
  <div id="loader">
    <div class="orbit orbit-outer">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    <div class="orbit orbit-inner">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    <div class="circle">
      <div class="twoQuarterBig"></div>
      <div class="twoQuarterSmall"></div>
      <div class="circleSmall"></div>
    </div>
    <div class="loading-text">Loading<span class="percent">0%</span></div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="container-fluid px-3 px-md-4" style="display:none;">
    <!-- Header -->
    <header class="header-section">
      <div class="row align-items-center">
        <div class="col">
          <h1>Report Manager</h1>
          <div class="mt-2 text-center text-white">
            <button class="btn btn-outline-light btn-sm me-2" onclick="window.location.href='index.html'">‚Üê
              Back</button>
            <button class="btn btn-outline-light btn-sm me-2" id="settingsBtn" style="display:none"
              onclick="window.location.href='settings.html'">‚öôÔ∏è Settings</button>
            <button class="btn btn-outline-light btn-sm" onclick="window.location.href='batch-manager.html'">üìö Batch
              Manager</button>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">üö™ Logout</button>
          </div>
        </div>
        <hr>
        <div id="authStatus">
          <strong>üîì Authenticated:</strong> <span id="currentUser">Loading...</span>
          <span id="userRole" class="badge bg-primary ms-2"></span>
        </div>
      </div>
    </header>

    <!-- Main Panels (Batches + Reports) -->
    <div class="row g-3 g-lg-4">
      <!-- LEFT: Batches -->
      <div class="col-12 col-lg-4 col-xl-3">
        <div class="batches-panel p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <strong>Batches</strong>
            <span class="text-muted small" id="totalBatches">0</span>
          </div>
          <input id="batchSearch" class="form-control form-control-sm mb-3" placeholder="Search batches...">
          <div id="batchesList" class="batches-list"></div>
        </div>
      </div>

      <!-- RIGHT: Reports -->
      <div class="col-12 col-lg-8 col-xl-9">
        <div class="reports-panel p-3 p-md-4">
          <!-- Filters -->
          <div class="filters-row row g-2 align-items-center mb-4">
            <div class="col"><input id="reportSearch" class="form-control form-control-sm"
                placeholder="Search reports..."></div>
            <div class="col-auto">
              <select id="groupFilter" class="form-select form-select-sm">
                <option value="all">All Groups</option>
                <option value="group1">Group 1</option>
                <option value="group2">Group 2</option>
                <option value="combined">Combined</option>
              </select>
            </div>
            <div class="col-auto">
              <div class="btn-group">
                <button id="btnExport" class="btn btn-export btn-sm" style="display:none">Export CSV</button>
                <button id="btnRefresh" class="btn btn-ghost btn-sm">Refresh</button>
              </div>
            </div>
          </div>

          <!-- Reports Header -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div><strong>Reports</strong>
              <div class="text-muted small" id="reportsCount">0 reports</div>
            </div>
            <div class="text-muted small" id="selectedBatchTag">All batches</div>
          </div>

          <!-- Reports Grid -->
          <div id="reportsList" class="row g-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade report-modal" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content bg-dark text-light shadow-lg rounded-4">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold">üìë Session Report</h5>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-success btn-sm" id="pmCopyBtn"><i class="bi bi-clipboard"></i>
              Copy</button>
            <button type="button" class="btn btn-primary btn-sm" id="pmDownloadBtn"><i class="bi bi-download"></i>
              Download</button>
            <button type="button" class="btn btn-warning btn-sm" id="pmPrintBtn"><i class="bi bi-printer"></i>
              Print</button>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
        </div>
        <div class="modal-body">
          <p><i class="bi bi-calendar3 me-2"></i><span id="pmDate">--</span></p>
          <p><i class="bi bi-person-badge me-2"></i><strong>Trainer:</strong> <span id="Trainer">-</span></p>
          <p><i class="bi bi-people-fill me-2"></i><strong>Coordinators:</strong> <span id="coordinator">-</span></p>
          <div class="report-box">
            <h6 class="fw-bold text-secondary mb-2"><i class="bi bi-journal-text me-2"></i> Session Notes</h6>
            <pre id="pmReportText" class="report-text"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS libs -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

  <!-- Your firebase wrapper (must expose `db`) -->
  <script type="module" src="src/firebase.js"></script>
  <script type="module" src="src/reports.js"></script>

  <!-- Loader -->
  <script type="module" src="src/logout.js"></script>

  <script>

    // Helper function to get element by ID
    const $ = (id) => document.getElementById(id);

    // Loader Animation
    const loader = $("loader");
    const main = $("mainContent");
    const percentEl = document.querySelector(".percent");
    let p = 0;

    const interval = setInterval(() => {
      p += Math.random() * 8;
      if (p >= 100) {
        p = 100;
        clearInterval(interval);
        loader.classList.add("fade-out");
        setTimeout(() => {
          loader.style.display = "none";
          main.style.display = "block";
        }, 900);
      }
      percentEl.textContent = Math.floor(p) + "%";
    }, 120);
  </script>
  <!-- Session-first logic + Firestore sessionVersion watch -->
  <script type="module">
    import { db } from "./src/firebase.js";
    import { doc, getDoc, onSnapshot } from "firebase/firestore";

    const currentUserEl = $("currentUser");
    const roleBadgeEl = $("userRole");
    const settingsBtn = $("settingsBtn");
    const exportBtn = $("btnExport");

    const allowedRoles = ["admin", "admins"];

    // read sessionStorage first
    let currentUser = null;
    try {
      const raw = sessionStorage.getItem("currentUser");
      currentUser = raw ? JSON.parse(raw) : null;
    } catch (e) {
      console.error("Failed to parse sessionStorage.currentUser", e);
      currentUser = null;
    }
 
    if (!currentUser || !allowedRoles.includes((currentUser.role || "").toLowerCase())) {
      // no local session ‚Äî block access
      Swal.fire({
        icon: "warning",
        title: "üîí Access Denied",
        text: "Please login first!"
      }).then(() => window.location.href = "index.html");
    } else {
      // render UI immediately from session
      const role = (currentUser.role || "").toLowerCase();
      currentUserEl.textContent = currentUser.email || currentUser.name || "User";
      roleBadgeEl.textContent = (role || "N/A").toUpperCase();
      roleBadgeEl.className = allowedRoles.includes(role) ? "badge bg-danger ms-2" : "badge bg-primary ms-2";

      if (allowedRoles.includes(role)) {
        settingsBtn.style.display = "inline-block";
        exportBtn.style.display = "inline-block";
      }

      // determine the admin doc id you're using in Firestore
      // Prefer currentUser.id (docSnap.id saved at login). Fall back to uid or email if that's how you stored it.
      const adminDocId = currentUser.id || currentUser.uid || currentUser.email;
      if (!adminDocId) {
        console.warn("No admin doc id found in session. Cannot validate sessionVersion.");
        // still let user continue, but don't attach watcher
      }

      // initial check: does the admin doc exist?
      (async () => {
        try {
          const ref = doc(db, "admins", adminDocId);
          const snapshot = await getDoc(ref);
          if (!snapshot.exists()) {
            console.warn("Admin doc not found for id:", adminDocId);
            sessionStorage.removeItem("currentUser");
            Swal.fire({ icon: "warning", title: "Access revoked", text: "Account not found. Please login again." })
              .then(() => window.location.href = "index.html");
            return;
          }

          // attach live watcher to sessionVersion (so admin can invalidate sessions)
          onSnapshot(ref, (snap) => {
            if (!snap.exists()) {
              // doc deleted -> force logout
              sessionStorage.removeItem("currentUser");
              Swal.fire({ icon: "info", title: "Session Expired", text: "Account removed. Please login again." })
                .then(() => window.location.href = "index.html");
              return;
            }
            const data = snap.data();
            const storedVersion = data.sessionVersion || 1;

            // always re-read sessionStorage to compare freshest local version
            let localVersion = 1;
            try {
              const s = sessionStorage.getItem("currentUser");
              const local = s ? JSON.parse(s) : null;
              localVersion = local?.sessionVersion || 1;
            } catch (e) {
              console.error("Failed to re-read sessionStorage for version", e);
            }

            if (storedVersion !== localVersion) {
              // session invalidated server-side
              sessionStorage.removeItem("currentUser");
              Swal.fire({ icon: "info", title: "Session Expired", text: "Your session was invalidated. Please login again." })
                .then(() => window.location.href = "index.html");
            }
          });
        } catch (err) {
          console.error("Error validating admin doc:", err);
          // On error we don't forcibly logout immediately ‚Äî show a message
          Swal.fire({ icon: "error", title: "Error", text: "Could not validate session (network or DB error). Try again later." });
        }
      })();
    }

  </script>
</body>

</html>