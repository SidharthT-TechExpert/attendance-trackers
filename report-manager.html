<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Report Manager ‚Äî Attendance</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles/report-manager.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

</head>

<body>
  <div class="container-fluid px-3 px-md-4">
    <!-- Header -->
    <header class="header-section">
      <div class="row align-items-center">
        <div class="col ">
          <h1>Report Manager</h1>
          <div class="mt-2 text-center text-white">

            <button class="btn btn-outline-light btn-sm me-2" onclick="window.location.href='index.html'">‚Üê Back to
              Attendance</button>
            <button class="btn btn-outline-light btn-sm me-2" id="settingsBtn"
              onclick="window.location.href='settings.html'">‚öôÔ∏è Settings</button>
            <button class="btn btn-outline-light btn-sm" onclick="window.location.href='batch-manager.html'">üìö Batch
              Manager</button>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">üö™ Logout</button>
          </div>
        </div>
        <br>
        <hr>
        <div id="authStatus">
          <!-- Authentication Status Display -->
          <strong>üîì Authenticated:</strong> <span id="currentUser">Loading...</span>
          <span id="userRole" class="badge bg-primary ms-2"></span>
        </div>
      </div>
    </header>

    <!-- Main Panel -->
    <div class="row g-3 g-lg-4">
      <!-- LEFT: Batches Panel -->
      <div class="col-12 col-lg-4 col-xl-3">
        <div class="batches-panel p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <strong>Batches</strong>
            <span class="text-muted small" id="totalBatches">0</span>
          </div>

          <div class="batch-search mb-3">
            <div class="row g-2">
              <div class="col">
                <input id="batchSearch" class="form-control form-control-sm" placeholder="Search batches..."
                  aria-label="Search batches" />
              </div>
            </div>
          </div>

          <div class="batches-list" id="batchesList">
            <!-- Batch items will be injected here -->
          </div>
        </div>
      </div>

      <!-- RIGHT: Reports Panel -->
      <div class="col-12 col-lg-8 col-xl-9">
        <div class="reports-panel p-3 p-md-4">
          <!-- Filters -->
          <div class="filters-row row g-2 align-items-center mb-4" role="region" aria-label="Report filters">
            <!-- <div class="col-auto">
              <div class="date-wrapper d-flex align-items-center px-2 py-1">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="me-2">
                  <path d="M7 10h5" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <input type="date" id="startDate" class="form-control-sm" aria-label="Start date"
                  style="border:none; background:transparent;" />
                <button class="date-clear" title="Clear start" data-target="startDate">‚úï</button>
              </div>
            </div> -->

            <!-- <div class="col-auto">
              <div class="date-wrapper d-flex align-items-center px-2 py-1">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="me-2">
                  <path d="M7 10h5" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <input type="date" id="endDate" class="form-control-sm" aria-label="End date"
                  style="border:none; background:transparent;" />
                <button class="date-clear" title="Clear end" data-target="endDate">‚úï</button>
              </div>
            </div> -->

            <div class="col">
              <input id="reportSearch" class="form-control form-control-sm"
                placeholder="Search reports (title, notes)..." />
            </div>

            <div class="col-auto">
              <select id="groupFilter" class="form-select form-select-sm">
                <option value="all">All Groups</option>
                <option value="group1">Group 1</option>
                <option value="group2">Group 2</option>
                <option value="combined">Combined</option>
              </select>
            </div>

            <div class="col-auto">
              <div class="btn-group" role="group">
                <button id="btnExport" class="btn btn-export btn-sm">Export CSV</button>
                <button id="btnRefresh" class="btn btn-ghost btn-sm">Refresh</button>
              </div>
            </div>
          </div>

          <!-- Reports Header -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <strong>Reports</strong>
              <div class="text-muted small" id="reportsCount">0 reports</div>
            </div>
            <div class="text-muted small" id="selectedBatchTag">All batches</div>
          </div>

          <!-- Reports Grid -->
          <div class="row g-3" id="reportsList">
            <!-- Report cards will be injected here -->
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Preview Modal -->
  <div class="modal fade report-modal" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content bg-dark text-light shadow-lg rounded-4">

        <!-- Header -->
        <div class="modal-header border-0 d-flex justify-content-between align-items-center">
          <div>
            <h5 class="modal-title fw-bold text-white mb-1" id="previewModalLabel">üìë Session Report</h5>
            <div class="d-flex gap-2">
              <span class="badge rounded-pill text-bg-primary" id="pmBatch">Batch: -</span>
              <span class="badge rounded-pill text-bg-secondary" id="pmGroup">Group: -</span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-success btn-sm d-flex align-items-center gap-1" id="pmCopyBtn">
              <i class="bi bi-clipboard"></i> Copy
            </button>
            <button type="button" class="btn btn-primary btn-sm d-flex align-items-center gap-1" id="pmDownloadBtn">
              <i class="bi bi-download"></i> Download
            </button>
            <button type="button" class="btn btn-warning btn-sm d-flex align-items-center gap-1" id="pmPrintBtn">
              <i class="bi bi-printer"></i> Print
            </button>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <div class="meta-line"><i class="bi bi-calendar3 me-2"></i><span id="pmDate">--</span></div>
            </div>
            <div class="col-md-4">
              <div class="meta-line"><i class="bi bi-people me-2"></i><span id="pmAttendees">-- attendees</span></div>
            </div>
            <div class="col-md-4 text-md-end small text-muted">
              <i class="bi bi-hash me-2"></i><span id="pmId"></span>
            </div>
          </div>

          <div class="mb-3">
            <p><i class="bi bi-person-badge me-2"></i><strong>Trainer:</strong> <span id="Trainer">-</span></p>
            <p><i class="bi bi-people-fill me-2"></i><strong>Coordinators:</strong> <span id="coordinator">-</span>
            </p>
          </div>

          <div class="report-box">
            <h6 class="fw-bold text-secondary mb-2"><i class="bi bi-journal-text me-2"></i> Session Notes</h6>
            <pre id="pmReportText" class="report-text"></pre>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer border-0 justify-content-end">
          <button type="button" class="btn btn-danger d-flex align-items-center gap-1" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Cancel
          </button>
        </div>
      </div>
    </div>
  </div>




  <!-- Bootstrap JS -->
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
  <!-- Firebase first -->
  <script type="module" src="src/firebase.js"></script>
  <script type="module" src="src/auth.js"></script>
  <script type="module" src="src/reports.js"></script>

  <script type="module">
    import { auth, db } from "./src/firebase.js";
    import { onAuthStateChanged, signOut } from "firebase/auth";
    import { doc, getDoc } from "firebase/firestore";

    const authStatusEl = document.getElementById("authStatus");
    const currentUserEl = document.getElementById("currentUser");
    const roleBadgeEl = document.getElementById("userRole");

    // üî• Listen for login/logout
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        authStatusEl.className = "alert alert-danger mb-4";
        currentUserEl.textContent = "Not logged in";
        roleBadgeEl.textContent = "";
        Swal.fire({
          icon: "warning",
          title: "üîí Access Denied",
          text: "Please login first!",
          confirmButtonText: "Go Back",
        }).then(() => {
          window.location.href = "./index.html";
        });
        return;
      }

      // ‚úÖ Show email
      authStatusEl.className = "";
      currentUserEl.textContent = user.email;

      // ‚úÖ Fetch role from Firestore
      let role = "coordinator"; // default
      try {
        const snap = await getDoc(doc(db, "roles", user.uid));
        if (snap.exists() && snap.data().role) {
          role = snap.data().role;
        }
      } catch (err) {
        console.error("Error fetching role:", err);
      }

      // ‚úÖ Update badge & show/hide buttons
      roleBadgeEl.textContent = role.toUpperCase();
      switch (role) {
        case "admin":
          roleBadgeEl.className = "badge bg-danger ms-2";
          document.getElementById("settingsBtn").style.display = "inline-block";
          document.getElementById("btnExport").style.display = "inline-block";
          break;
        case "manager":
          roleBadgeEl.className = "badge bg-warning ms-2";
          break;
        case "coordinator":
          roleBadgeEl.className = "badge bg-info ms-2";
          break;
        default:
          roleBadgeEl.className = "badge bg-secondary ms-2";
      }

      // ‚úÖ Make globally accessible
      window.currentUser = { email: user.email, role };
    });

    // ====================== LOGOUT ======================
    window.logout = async function () {
      Swal.fire({
        title: "üö™ Logout",
        text: "Are you sure you want to logout?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Yes, logout",
        cancelButtonText: "Cancel",
        confirmButtonColor: "#004d61",
      }).then(async (result) => {
        if (result.isConfirmed) {
          await signOut(auth);
          Swal.fire({
            icon: "success",
            title: "üëã Logged Out",
            text: "You have been logged out successfully",
            showConfirmButton: false,
            timer: 1500,
          }).then(() => {
            window.location.href = "index.html";
          });
        }
      });
    };
  </script>

</body>

</html>