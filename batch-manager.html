<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batch Manager - Attendance App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon"
    href="https://raw.githubusercontent.com/SidharthT-TechExpert/attendance-tracker/refs/heads/main/Img/logo.webp">
  <link rel="stylesheet" href="/styles/batch-manager.css">
</head>

<body>
  <!-- Loader -->
  <div id="loader">
    <div class="orbit orbit-outer">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    <div class="orbit orbit-inner">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    <div class="circle">
      <div class="twoQuarterBig"></div>
      <div class="twoQuarterSmall"></div>
      <div class="circleSmall"></div>
    </div>
    <div class="loading-text">Loading<span class="percent">0%</span></div>
  </div>

  <!-- Header section -->
  <header class="text-center text-white">
    <h4 class="m-0">Batch Manager</h4>
    <small id="currentDate"></small>
    <p>Manage batches and participants for attendance tracking</p>
    <div class="mt-2">
      <button class="btn btn-outline-light btn-sm me-2" onclick="window.location.href='index.html'">← Back to
        Attendance</button>
      <button class="btn btn-outline-light btn-sm me-2" id="settingsBtn" onclick="window.location.href='settings.html'"
        style="display: none;">⚙️ Settings</button>
      <button class="btn btn-outline-light btn-sm me-2" id="AdminBtn"
        onclick="window.location.href='admin-manager.html'" style="display: none;">👑Admin Manager</button>
      <button class="btn btn-outline-light btn-sm me-2" id="ReportBtn"
        onclick="window.location.href='report-manager.html'" style="display: none;">📘Report Manager</button>
      <button class="btn btn-outline-danger btn-sm" onclick="logout()">🚪 Logout</button>
    </div>
  </header>

  <div id="mainContent" style="display: none;" class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-12 col-md-10">
        <div class="container-box">

          <!-- Authentication Status Display -->
          <div class="alert alert-success mb-4" id="authStatus">
            <strong>🔓 Authenticated:</strong> <span id="currentUser">Loading...</span>
            <span id="userRole" class="badge bg-primary ms-2"></span>
          </div>

          <!-- Batch Management Section -->
          <div class="row mb-4">
            <div class="col-md-6">
              <h5>📚 Batch Management</h5>
              <div class="input-group mb-3">
                <span class="input-group-text">Batch</span>
                <input type="text" id="newBatchName" class="form-control"
                  placeholder="Enter batch ID (e.g., BCR71, BRA1, BCK28)" autocomplete="off">
                <button class="btn btn-success" onclick="addNewBatch()">Add Batch</button>
              </div>
            </div>
            <div class="col-md-6">
              <h5>📊Import Batches </h5>
              <div class="d-flex gap-2">
                <button class="btn btn-info btn-sm" onclick="importData()">📥 Import</button>
                <button id="export" style="display: none;" class="btn btn-info btn-sm" onclick="exportAllData()">📤
                  Export</button>
              </div>
            </div>
          </div>

          <!-- Participant Type Legend -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title">📋 Participant Type Legend</h6>
                  <div class="row">
                    <div class="col-md-4">
                      <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-info me-2">RP</span>
                        <span><strong>Refreshment Period</strong> - Participants on break/refreshment period</span>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-warning me-2">C</span>
                        <span><strong>Coordinator</strong> - Group coordinators (max 2 per group)</span>
                      </div>
                      <small class="text-muted ms-4">⚠️ Maximum 2 coordinators allowed per group</small>
                    </div>
                    <div class="col-md-4">
                      <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-secondary me-2">Normal</span>
                        <span><strong>Normal</strong> - Standard participants</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Batch List + Details -->
          <div class="row">
            <div class="col-md-4">
              <h6>📋 Available Batches</h6>

              <!-- 🔍 Search Bar -->
              <div class="search-box mb-3">
                <span class="search-icon">🔍</span>
                <input type="text" id="batchSearch" class="form-control form-control-sm search-input"
                  placeholder="Search batches..." autocomplete="off">
              </div>


              <!-- Batch List -->
              <div id="batchList" class="list-group"
                style="max-height:400px; overflow-y:auto; overflow-x:hidden; border:1px solid #ddd; border-radius:6px;">
              </div>
            </div>

            <div class="col-md-8">
              <div id="batchDetails" style="display: none;">
                <h6 id="selectedBatchTitle">Batch Details</h6>

                <!-- Group 2 Toggle -->
                <div class="mb-3 form-check form-switch" style="margin-left: 10px;">
                  <input class="form-check-input" type="checkbox" id="hasGroup2" onchange="toggleGroup2()">
                  <label class="form-check-label" for="hasGroup2">Enable Group 2</label>
                </div>

                <div class="col-md-6">
                  <h5>👨🏻‍🏫 Enter your Batch Trainer</h5>
                  <div class="input-group mb-3">
                    <span class="input-group-text">Trainer</span>
                    <input type="text" id="TrainerName" class="form-control"
                      placeholder="e.g.: Afzal Nazar (One-time set or for editing purposes)" autocomplete="off">
                    <button id="Trainer" class="btn btn-success" onclick="addTrainer()">Set</button>
                  </div>
                </div>

                <!-- Session Time -->
                <div class="custom-dropdown col-md-4 time-selection">
                  <label for="time" class="form-label">⏰ Select Time</label>
                  <button id="TimeB" class="dropdown-btn">⏰ Select Time <span class="arrow">⌄</span></button>
                  <ul class="dropdown-menu">
                    <li>10:00 AM - 11:00 AM</li>
                    <li>10:30 AM - 11:30 AM</li>
                    <li>11:00 AM - 12:00 PM</li>
                    <li>11:30 AM - 12:30 PM</li>
                    <li>12:00 PM - 01:00 PM</li>
                    <li>12:30 PM - 01:30 PM</li>
                    <li>01:00 PM - 02:00 PM</li>
                    <li>01:30 PM - 02:30 PM</li>
                    <li>02:00 PM - 03:00 PM</li>
                    <li>02:30 PM - 03:30 PM</li>
                    <li>03:00 PM - 04:00 PM</li>
                    <li>03:30 PM - 04:30 PM</li>
                    <li>04:00 PM - 05:00 PM</li>
                    <li>04:30 PM - 05:30 PM</li>
                    <li>05:00 PM - 06:00 PM</li>
                    <li>05:30 PM - 06:30 PM</li>
                    <li>06:00 PM - 07:00 PM</li>
                    <li>06:30 PM - 07:30 PM</li>
                    <li>07:00 PM - 08:00 PM</li>
                    <li>07:30 PM - 08:30 PM</li>
                    <li>08:00 PM - 09:00 PM</li>
                    <li>08:30 PM - 09:30 PM</li>
                    <li>09:00 PM - 10:00 PM</li>
                    <li>09:30 PM - 10:30 PM</li>
                    <li>10:00 PM - 11:00 PM</li>
                  </ul>
                  <input type="hidden" id="time">
                </div>


                <!-- Group 1 -->
                <div class="mb-4">
                  <h6>👥 Group 1</h6>
                  <div class="input-group mb-2">
                    <input type="text" id="newParticipant1" class="form-control "
                      style="background-color: rgb(221, 212, 212);font-weight: bolder;"
                      placeholder="Enter participant name" autocomplete="off">
                    <button class="btn btn-success btn-sm" onclick="addParticipant('Group_1')">Add</button>
                  </div>
                  <div id="group1List"></div>
                </div>

                <!-- Group 2 -->
                <div id="group2Section" class="mb-4 " style="display:none;">
                  <h6>👥 Group 2</h6>
                  <div class="input-group mb-2">
                    <input type="text" id="newParticipant2" class="form-control bg-secondary"
                      style="background-color: rgb(221, 212, 212);font-weight: bolder;"
                      placeholder="Enter participant name" autocomplete="off">
                    <button class="btn btn-success btn-sm" onclick="addParticipant('Group_2')">Add</button>
                  </div>
                  <div id="group2List"></div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-danger btn-sm" onclick="deleteBatch()">🗑️ Delete</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 🔴 Error popup -->
  <div id="errorPopup" class="error-popup">
    <span class="error-icon">⚠</span>
    <span id="errorMessage"></span>
  </div>


  <!-- JavaScript files -->
  <!-- JavaScript files -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module" src="src/firebase.js"></script>
  <script type="module" src="src/batch-manager.js"></script>
  <script type="module" src="src/auth.js"></script> -->

  <script>
    // Helper
    const $ = (id) => document.getElementById(id);

    // Loader animation
    const loader = $("loader");
    const main = $("mainContent");
    const percentEl = document.querySelector(".percent");
    let p = 0;
    const interval = setInterval(() => {
      p += Math.random() * 8;
      if (p >= 100) {
        p = 100;
        clearInterval(interval);
        loader.classList.add("fade-out");
        setTimeout(() => {
          loader.style.display = "none";
          main.style.display = "block";
        }, 900);
      }
      percentEl.textContent = Math.floor(p) + "%";
    }, 120);
  </script>

  <script type="module">
    import { db } from "./src/firebase.js";
    import { doc, getDoc, onSnapshot } from "firebase/firestore";

    const authStatusEl = $("authStatus");
    const currentUserEl = $("currentUser");
    const roleBadgeEl = $("userRole");

    let currentUser = null;
    try {
      const raw = sessionStorage.getItem("currentUser");
      if (raw) currentUser = JSON.parse(raw);
    } catch (e) {
      console.error("Failed to parse session user:", e);
    }

    async function validateSession() {
      if (!currentUser) {
        await Swal.fire({
          icon: "warning",
          title: "🔒 Access Denied",
          text: "Please login first!",
          confirmButtonText: "Go Back",
        });
        window.location.href = "./index.html";
        return;
      }

      try {
        // 🔎 Fetch latest user doc
        const ref = doc(db, "admins", currentUser.id); // ✅ use doc id, not email
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          sessionStorage.removeItem("currentUser");
          window.location.href = "./index.html";
          return;
        }

        const data = snap.data();

        // 🚨 Check sessionVersion
        if ((data.sessionVersion || 1) !== (currentUser.sessionVersion || 1)) {
          sessionStorage.removeItem("currentUser");
          await Swal.fire({
            icon: "info",
            title: "🔄 Session Expired",
            text: "Your account was updated. Please log in again.",
            confirmButtonText: "OK",
          });
          window.location.href = "./index.html";
          return;
        }

        // ✅ UI setup
        const role = currentUser.role?.toLowerCase().trim();
        authStatusEl.className = "alert alert-success mb-4";
        currentUserEl.textContent = currentUser.name?.toUpperCase() || currentUser.email;
        roleBadgeEl.textContent = role.toUpperCase();
        roleBadgeEl.className = "badge bg-danger ms-2";

        const allowed = ["admin", "admins", "manager", "coordinator"];
        if (allowed.includes(role)) {
          $("settingsBtn").style.display = "inline-block";
          $("ReportBtn").style.display = "inline-block";
          $("AdminBtn").style.display = "inline-block";
        }


        window.currentUser = currentUser;

        // 🔴 Realtime session listener
        onSnapshot(ref, (snap) => {
          if (!snap.exists()) return;
          const live = snap.data();
          if ((live.sessionVersion || 1) !== (currentUser.sessionVersion || 1)) {
            sessionStorage.removeItem("currentUser");
            Swal.fire({
              icon: "info",
              title: "🔄 Session Expired",
              text: "Your session was invalidated. Please log in again.",
            }).then(() => {
              window.location.href = "./index.html";
            });
          }
        });

      } catch (err) {
        console.error("Session validation error:", err);
        sessionStorage.removeItem("currentUser");
        window.location.href = "./index.html";
      }
    }

    window.addEventListener("DOMContentLoaded", validateSession);

    // ====================== LOGOUT ======================
    window.logout = function () {
      Swal.fire({
        title: "🚪 Logout",
        text: "Are you sure you want to logout?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Yes, logout",
        cancelButtonText: "Cancel",
        confirmButtonColor: "#004d61",
      }).then((result) => {
        if (result.isConfirmed) {
          sessionStorage.removeItem("currentUser");
          Swal.fire({
            icon: "success",
            title: "👋 Logged Out",
            text: "You have been logged out successfully",
            showConfirmButton: false,
            timer: 1500,
          }).then(() => {
            window.location.href = "index.html";
          });
        }
      });
    };
  </script>


</body>

</html>