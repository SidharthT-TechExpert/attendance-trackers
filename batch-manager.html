<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batch Manager - Attendance App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon"
    href="https://raw.githubusercontent.com/SidharthT-TechExpert/attendance-tracker/refs/heads/main/Img/logo.webp">
  <link rel="stylesheet" href="batch-manager.css">
</head>

<body> <!-- Header section -->
  <header class="text-center text-white">
    <h4 class="m-0">Batch Manager</h4>
    <small id="currentDate"></small>
    <p>Manage batches and participants for attendance tracking</p>
    <div class="mt-2">
      <button class="btn btn-outline-light btn-sm me-2" onclick="window.location.href='index.html'">← Back to
        Attendance</button>
      <button class="btn btn-outline-light btn-sm me-2" id="settingsBtn" onclick="window.location.href='settings.html'"
        style="display: none;">⚙️ Settings</button>
      <button class="btn btn-outline-danger btn-sm" onclick="logout()">🚪 Logout</button>
    </div>
  </header>

  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-12 col-md-10">
        <div class="container-box">

          <!-- Authentication Status Display -->
          <div class="alert alert-success mb-4" id="authStatus">
            <strong>🔓 Authenticated:</strong> <span id="currentUser">Loading...</span>
            <span id="userRole" class="badge bg-primary ms-2"></span>
          </div>

          <!-- Batch Management Section -->
          <div class="row mb-4">
            <div class="col-md-6">
              <h5>📚 Batch Management</h5>
              <div class="input-group mb-3">
                <span class="input-group-text">BC</span>
                <input type="text" id="newBatchName" class="form-control"
                  placeholder="Enter batch suffix (e.g., R71, A1, 2024)">
                <button class="btn btn-success" onclick="addNewBatch()">Add Batch</button>
              </div>
            </div>
            <div class="col-md-6">
              <h5>📊 Batches </h5>
              <div class="d-flex gap-2">
                <button class="btn btn-info btn-sm" onclick="importData()">📥 Import</button>
                <button class="btn btn-info btn-sm" onclick="exportAllData()">📤 Export</button>
              </div>
            </div>
          </div>

          <!-- Participant Type Legend -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title">📋 Participant Type Legend</h6>
                  <div class="row">
                    <div class="col-md-4">
                      <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-info me-2">RP</span>
                        <span><strong>Refreshment Period</strong> - Participants on break/refreshment period</span>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-warning me-2">C</span>
                        <span><strong>Coordinator</strong> - Group coordinators (max 2 per group)</span>
                      </div>
                      <small class="text-muted ms-4">⚠️ Maximum 2 coordinators allowed per group</small>
                    </div>
                    <div class="col-md-4">
                      <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-secondary me-2">Normal</span>
                        <span><strong>Normal</strong> - Standard participants</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Batch List + Details -->
          <div class="row">
            <div class="col-md-4">
              <h6>📋 Available Batches</h6>
              <div id="batchList" class="list-group"></div>
            </div>

            <div class="col-md-8">
              <div id="batchDetails" style="display: none;">
                <h6 id="selectedBatchTitle">Batch Details</h6>
                <div class="mb-3 form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="hasGroup2" onchange="toggleGroup2()">
                  <label class="form-check-label" for="hasGroup2">Enable Group 2</label>
                </div>
                <div class="mb-4">
                  <h6>👥 Group 1</h6>
                  <div class="input-group mb-2">
                    <input type="text" id="newParticipant1" class="form-control" placeholder="Enter participant name">
                    <button class="btn btn-success btn-sm" onclick="addParticipant('Group_1')">Add</button>
                  </div>
                  <div id="group1List"></div>
                </div>
                <div id="group2Section" class="mb-4" style="display:none;">
                  <h6>👥 Group 2</h6>
                  <div class="input-group mb-2">
                    <input type="text" id="newParticipant2" class="form-control" placeholder="Enter participant name">
                    <button class="btn btn-success btn-sm" onclick="addParticipant('Group_2')">Add</button>
                  </div>
                  <div id="group2List"></div>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-primary btn-sm" onclick="saveBatchChanges()">💾 Save</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteBatch()">🗑️ Delete</button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- 🔴 Error popup -->
  <div id="errorPopup" class="error-popup">
    <span class="error-icon">⚠</span>
    <span id="errorMessage"></span>
  </div>


  <!-- JavaScript files -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module" src="firebase.js"></script>
  <script type="module" src="batch-manager.js"></script>
  <script src="auth.js"></script>

  <script>
    // ====================== AUTHENTICATION CHECK ======================

    // Check if user is authenticated when page loads
    document.addEventListener('DOMContentLoaded', function () {
      // Check if user is authenticated
      window.currentUser = getCurrentUser();

      if (!currentUser) {
        // If not authenticated, redirect back
        Swal.fire({
          icon: 'warning',
          title: '🔒 Access Denied',
          text: 'Please authenticate through the main page to access Batch Manager.',
          confirmButtonText: 'Go to Login',
          confirmButtonColor: '#004d61',
          allowOutsideClick: false,
          allowEscapeKey: false
        }).then(() => {
          window.location.href = 'index.html';
        });
        return;
      }

      // Set session flag to allow direct refresh
      sessionStorage.setItem('batchManagerAccess', 'true');

      // Update current user display
      document.getElementById('currentUser').textContent = currentUser.email;

      // Update role badge
      const roleBadge = document.getElementById('userRole');
      roleBadge.textContent = currentUser.role.toUpperCase();

      // Set badge color based on role
      switch (currentUser.role) {
        case 'admin':
          roleBadge.className = 'badge bg-danger ms-2';
          break;
        case 'manager':
          roleBadge.className = 'badge bg-warning ms-2';
          break;
        case 'coordinator':
          roleBadge.className = 'badge bg-info ms-2';
          break;
        default:
          roleBadge.className = 'badge bg-secondary ms-2';
      }

      // Show settings button only for admin users
      if (currentUser.role === 'admin') {
        document.getElementById('settingsBtn').style.display = 'inline-block';
      }
    });

    // Logout function
    function logout() {
      Swal.fire({
        title: '🚪 Logout',
        text: 'Are you sure you want to logout?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, logout',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#004d61'
      }).then((result) => {
        if (result.isConfirmed) {
          // Clear session
          sessionStorage.removeItem('batchManagerAccess');
          sessionStorage.removeItem('currentUser');

          Swal.fire({
            icon: 'success',
            title: '👋 Logged Out',
            text: 'You have been logged out successfully',
            showConfirmButton: false,
            timer: 1500
          }).then(() => {
            window.location.href = 'index.html';
          });
        }
      });
    }

    // ============= ERROR POPUP HANDLER =============
    function showError(message) {
      const popup = document.getElementById("errorPopup");
      popup.textContent = message;
      popup.style.display = "block";
    }

    function hideError() {
      document.getElementById("errorPopup").style.display = "none";
    }
    window.showError = showError;
    window.hideError = hideError;
  </script>

</body>

</html>