<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batch Manager - Attendance App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon"
    href="https://raw.githubusercontent.com/SidharthT-TechExpert/attendance-tracker/refs/heads/main/Img/logo.webp">
  <link rel="stylesheet" href="/styles/batch-manager.css">
</head>

<body>
  <!-- Loader -->
  <div id="loader">
    <div class="orbit orbit-outer">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    <div class="orbit orbit-inner">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    <div class="circle">
      <div class="twoQuarterBig"></div>
      <div class="twoQuarterSmall"></div>
      <div class="circleSmall"></div>
    </div>
    <div class="loading-text">Loading<span class="percent">0%</span></div>
  </div>

  <!-- Header section -->
  <header class="text-center text-white">
    <h4 class="m-0">Batch Manager</h4>
    <small id="currentDate"></small>
    <p>Manage batches and participants for attendance tracking</p>
    <div class="mt-2">
      <button class="btn btn-outline-light btn-sm me-2" onclick="window.location.href='index.html'">â† Back to
        Attendance</button>
      <button class="btn btn-outline-light btn-sm me-2" id="settingsBtn" onclick="window.location.href='settings.html'"
        style="display: none;">âš™ï¸ Settings</button>
      <button class="btn btn-outline-light btn-sm me-2" id="ReportBtn"
        onclick="window.location.href='report-manager.html'" style="display: none;">ğŸ“˜Report Manager</button>
      <button class="btn btn-outline-danger btn-sm" onclick="logout()">ğŸšª Logout</button>
    </div>
  </header>

  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-12 col-md-10">
        <div class="container-box">

          <!-- Authentication Status Display -->
          <div class="alert alert-success mb-4" id="authStatus">
            <strong>ğŸ”“ Authenticated:</strong> <span id="currentUser">Loading...</span>
            <span id="userRole" class="badge bg-primary ms-2"></span>
          </div>

          <!-- Batch Management Section -->
          <div class="row mb-4">
            <div class="col-md-6">
              <h5>ğŸ“š Batch Management</h5>
              <div class="input-group mb-3">
                <span class="input-group-text">Batch</span>
                <input type="text" id="newBatchName" class="form-control"
                  placeholder="Enter batch ID (e.g., BCR71, BRA1, BCK28)" autocomplete="off">
                <button class="btn btn-success" onclick="addNewBatch()">Add Batch</button>
              </div>
            </div>
            <div class="col-md-6">
              <h5>ğŸ“ŠImport Batches </h5>
              <div class="d-flex gap-2">
                <button class="btn btn-info btn-sm" onclick="importData()">ğŸ“¥ Import</button>
                <button id="export" style="display: none;" class="btn btn-info btn-sm" onclick="exportAllData()">ğŸ“¤
                  Export</button>
              </div>
            </div>
          </div>

          <!-- Participant Type Legend -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title">ğŸ“‹ Participant Type Legend</h6>
                  <div class="row">
                    <div class="col-md-4">
                      <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-info me-2">RP</span>
                        <span><strong>Refreshment Period</strong> - Participants on break/refreshment period</span>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-warning me-2">C</span>
                        <span><strong>Coordinator</strong> - Group coordinators (max 2 per group)</span>
                      </div>
                      <small class="text-muted ms-4">âš ï¸ Maximum 2 coordinators allowed per group</small>
                    </div>
                    <div class="col-md-4">
                      <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-secondary me-2">Normal</span>
                        <span><strong>Normal</strong> - Standard participants</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Batch List + Details -->
          <div class="row">
            <div class="col-md-4">
              <h6>ğŸ“‹ Available Batches</h6>

              <!-- ğŸ” Search Bar -->
              <div class="search-box mb-3">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="batchSearch" class="form-control form-control-sm search-input"
                  placeholder="Search batches..." autocomplete="off">
              </div>


              <!-- Batch List -->
              <div id="batchList" class="list-group"
                style="max-height:400px; overflow-y:auto; overflow-x:hidden; border:1px solid #ddd; border-radius:6px;">
              </div>
            </div>

            <div class="col-md-8">
              <div id="batchDetails" style="display: none;">
                <h6 id="selectedBatchTitle">Batch Details</h6>

                <!-- Group 2 Toggle -->
                <div class="mb-3 form-check form-switch" style="margin-left: 10px;">
                  <input class="form-check-input" type="checkbox" id="hasGroup2" onchange="toggleGroup2()">
                  <label class="form-check-label" for="hasGroup2">Enable Group 2</label>
                </div>

                <div class="col-md-6">
                  <h5>ğŸ‘¨ğŸ»â€ğŸ« Enter your Batch Trainer</h5>
                  <div class="input-group mb-3">
                    <span class="input-group-text">Trainer</span>
                    <input type="text" id="TrainerName" class="form-control"
                      placeholder="e.g.: Afzal Nazar (One-time set or for editing purposes)" autocomplete="off">
                    <button id="Trainer" class="btn btn-success" onclick="addTrainer()">Set</button>
                  </div>
                </div>

                <!-- Session Time -->
                <div class="custom-dropdown col-md-4 time-selection">
                  <label for="time" class="form-label">â° Select Time</label>
                  <button id="TimeB" class="dropdown-btn">â° Select Time <span class="arrow">âŒ„</span></button>
                  <ul class="dropdown-menu">
                    <li>10:00 AM - 11:00 AM</li>
                    <li>11:30 AM - 12:30 PM</li>
                    <li>02:00 PM - 03:00 PM</li>
                    <li>03:00 PM - 04:00 PM</li>
                    <li>04:00 PM - 05:00 PM</li>
                    <li>04:30 PM - 05:30 PM</li>
                  </ul>
                  <input type="hidden" id="time">
                </div>


                <!-- Group 1 -->
                <div class="mb-4">
                  <h6>ğŸ‘¥ Group 1</h6>
                  <div class="input-group mb-2">
                    <input type="text" id="newParticipant1" class="form-control "
                      style="background-color: rgb(221, 212, 212);font-weight: bolder;"
                      placeholder="Enter participant name" autocomplete="off">
                    <button class="btn btn-success btn-sm" onclick="addParticipant('Group_1')">Add</button>
                  </div>
                  <div id="group1List"></div>
                </div>

                <!-- Group 2 -->
                <div id="group2Section" class="mb-4 " style="display:none;">
                  <h6>ğŸ‘¥ Group 2</h6>
                  <div class="input-group mb-2">
                    <input type="text" id="newParticipant2" class="form-control bg-secondary"
                      style="background-color: rgb(221, 212, 212);font-weight: bolder;"
                      placeholder="Enter participant name" autocomplete="off">
                    <button class="btn btn-success btn-sm" onclick="addParticipant('Group_2')">Add</button>
                  </div>
                  <div id="group2List"></div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-danger btn-sm" onclick="deleteBatch()">ğŸ—‘ï¸ Delete</button>
                </div>
              </div>
            </div>
          </div>


          <!-- ğŸ”´ Error popup -->
          <div id="errorPopup" class="error-popup">
            <span class="error-icon">âš </span>
            <span id="errorMessage"></span>
          </div>


          <!-- JavaScript files -->
          <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
          <script type="module" src="/src/firebase.js"></script>
          <script type="module" src="/src/batch-manager.js"></script>
          <script type="module" src="/src/auth.js"></script>

          <script>
            const loader = document.getElementById("loader");
            const main = document.getElementById("mainContent");
            const percentEl = document.querySelector(".percent");
            let p = 0;

            const interval = setInterval(() => {
              p += Math.random() * 8;
              if (p >= 100) {
                p = 100;
                clearInterval(interval);
                loader.classList.add("fade-out");
                setTimeout(() => {
                  loader.style.display = "none";
                  main.style.display = "block";
                }, 900);
              }
              percentEl.textContent = Math.floor(p) + "%";
            }, 120);
          </script>

          <script type="module">
            import { auth, db } from "./src/firebase.js";
            import { onAuthStateChanged, signInWithEmailAndPassword, signOut } from "firebase/auth";
            import { doc, getDoc, setDoc, collection, getDocs } from "firebase/firestore";

            const authStatusEl = document.getElementById("authStatus");
            const currentUserEl = document.getElementById("currentUser");
            const roleBadgeEl = document.getElementById("userRole");

            // ğŸ”¥ Listen for login/logout
            onAuthStateChanged(auth, async (user) => {
              if (!user) {
                authStatusEl.className = "alert alert-danger mb-4";
                currentUserEl.textContent = "Not logged in";
                roleBadgeEl.textContent = "";
                Swal.fire({
                  icon: "warning",
                  title: "ğŸ”’ Access Denied",
                  text: "Please login first!",
                  confirmButtonText: "Go Back",
                }).then(() => {
                  window.location.href = "../index.html";
                });
                return;
              }

              // âœ… Show email
              authStatusEl.className = "alert alert-success mb-4";
              currentUserEl.textContent = user.email;

              // âœ… Fetch role from Firestore
              let role = "coordinator"; // default
              try {
                const snap = await getDoc(doc(db, "roles", user.uid));
                if (snap.exists() && snap.data().role) {
                  role = snap.data().role;
                }
              } catch (err) {
                console.error("Error fetching role:", err);
              }

              // âœ… Update badge
              roleBadgeEl.textContent = role.toUpperCase();
              switch (role) {
                case "admin":
                  roleBadgeEl.className = "badge bg-danger ms-2";
                  document.getElementById("settingsBtn").style.display = "inline-block";
                  document.getElementById("export").style.display = "inline-block"
                  document.getElementById('ReportBtn').style.display = 'inline-block'
                  break;
                case "manager":
                  roleBadgeEl.className = "badge bg-warning ms-2";
                  break;
                case "coordinator":
                  roleBadgeEl.className = "badge bg-info ms-2";
                  break;
                default:
                  roleBadgeEl.className = "badge bg-secondary ms-2";
              }

              // âœ… Make globally accessible
              window.currentUser = { email: user.email, role };
            });

            // ====================== LOGOUT ======================
            window.logout = async function () {
              Swal.fire({
                title: "ğŸšª Logout",
                text: "Are you sure you want to logout?",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Yes, logout",
                cancelButtonText: "Cancel",
                confirmButtonColor: "#004d61",
              }).then(async (result) => {
                if (result.isConfirmed) {
                  await auth.signOut();
                  Swal.fire({
                    icon: "success",
                    title: "ğŸ‘‹ Logged Out",
                    text: "You have been logged out successfully",
                    showConfirmButton: false,
                    timer: 1500,
                  }).then(() => {
                    window.location.href = "index.html";
                  });
                }
              });
            };
          </script>

</body>

</html>